// ===================================
// CONFIG
// ===================================
const SHEET_NAME = "Form_Responses";   
const TELEGRAM_TOKEN = "8518184621:AAHRUV9MjWBbhNfyGqUDSWzBJah_l04xB10";
const TELEGRAM_CHAT_ID = "-1003472863219";

// ===================================
// MAIN WEB APP FUNCTION
// ===================================
function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);

    const rowId = data.id;          // timestamp (‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏á‡∏≤‡∏ô)
    const driverName = data.driver; // ‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö

    const result = updateJob(rowId, driverName);

    if (result.status === "success") {
      sendTelegram(
        "üöñ ‡∏°‡∏µ‡∏Ñ‡∏ô‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß!\n\n" +
        `üìå ‡∏£‡∏´‡∏±‡∏™‡∏á‡∏≤‡∏ô: ${rowId}\n` +
        `üë®‚Äç‚úàÔ∏è ‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö: ${driverName}\n` +
        `‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤: ${new Date().toLocaleString("th-TH")}\n`
      );
    }

    return ContentService.createTextOutput(JSON.stringify(result))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (err) {
    return ContentService.createTextOutput(
      JSON.stringify({ status: "error", message: err.toString() })
    );
  }
}

// ===================================
// UPDATE JOB IN SHEET
// ===================================
function updateJob(rowId, driverName) {

  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
  const data = sheet.getDataRange().getValues();

  for (let i = 1; i < data.length; i++) {

    let timestamp = data[i][0]; // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå A = Timestamp

    // ‡πÉ‡∏ä‡πâ timestamp ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏á‡∏≤‡∏ô
    if (String(timestamp) === String(rowId)) {

      // H = Driver
      sheet.getRange(i + 1, 8).setValue(driverName);

      // I = Status
      sheet.getRange(i + 1, 9).setValue("‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß");

      // J = AcceptTime
      sheet.getRange(i + 1, 10).setValue(new Date());

      return { status: "success", row: i + 1 };
    }
  }

  return { status: "not_found" };
}

// ===================================
// SEND TELEGRAM MESSAGE
// ===================================
function sendTelegram(msg) {

  const url = `https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`;

  const payload = {
    chat_id: TELEGRAM_CHAT_ID,
    text: msg
  };

  UrlFetchApp.fetch(url, {
    method: "post",
    contentType: "application/json",
    payload: JSON.stringify(payload)
  });
}
